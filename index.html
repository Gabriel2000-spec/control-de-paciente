<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Control Clínico de Pacientes</title>
<style>
  /* Estilos base */
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: #f0f4f8;
    color: #222;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  h1, h2, h3 {
    margin: 0 0 10px 0;
  }
  button {
    cursor: pointer;
  }
  input, select, textarea, button {
    font-family: inherit;
    font-size: 1rem;
  }

  /* Contenedor general */
  #app {
    display: flex;
    flex-grow: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* Login */
  #login {
    margin: auto;
    padding: 30px 40px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 20px rgb(0 0 0 / 0.1);
    max-width: 350px;
    width: 90vw;
  }
  #login h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #007BFF;
  }
  #login label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }
  #login input {
    width: 100%;
    padding: 8px 12px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: border-color 0.3s ease;
  }
  #login input:focus {
    border-color: #007BFF;
    outline: none;
  }
  #login button {
    width: 100%;
    padding: 10px;
    background-color: #007BFF;
    color: white;
    font-weight: 700;
    border: none;
    border-radius: 6px;
    transition: background-color 0.3s ease;
  }
  #login button:hover {
    background-color: #0056b3;
  }
  #login .error {
    color: #d93025;
    font-size: 0.9rem;
    text-align: center;
    margin-top: -10px;
    margin-bottom: 10px;
  }

  /* Menú lateral */
  #sidebar {
    width: 280px;
    background-color: #004085;
    color: white;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    min-height: 100vh;
    overflow-y: auto;
    position: relative;
    z-index: 100;
  }
  #sidebar.hidden {
    transform: translateX(-100%);
  }
  #sidebar header {
    padding: 20px;
    font-size: 1.5rem;
    font-weight: 700;
    background-color: #002752;
    user-select: none;
  }
  #sidebar nav {
    flex-grow: 1;
    padding: 10px 0;
  }
  #sidebar nav button {
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    padding: 12px 25px;
    color: white;
    font-weight: 600;
    border-left: 5px solid transparent;
    transition: background-color 0.2s ease, border-color 0.3s ease;
  }
  #sidebar nav button:hover,
  #sidebar nav button.active {
    background-color: #0056b3;
    border-left-color: #ffc107;
  }
  #sidebar footer {
    padding: 15px 20px;
    font-size: 0.9rem;
    background-color: #002752;
    color: #ccc;
    text-align: center;
    user-select: none;
  }
  /* Botón hamburguesa */
  #hamburger {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 120;
    background: #007BFF;
    border: none;
    padding: 10px 12px;
    border-radius: 4px;
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    display: none;
  }
  #hamburger:focus {
    outline: 2px solid #ffc107;
  }

  /* Contenido principal */
  #main-content {
    flex-grow: 1;
    padding: 20px 25px;
    overflow-y: auto;
    min-height: 100vh;
    background: white;
  }
  #main-content h2 {
    color: #004085;
  }

  /* Formulario paciente */
  form {
    max-width: 900px;
    margin-bottom: 25px;
  }
  form .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  form label {
    flex: 1 0 120px;
    font-weight: 600;
    align-self: center;
  }
  form input, form select, form textarea {
    flex: 2 0 250px;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: border-color 0.3s ease;
  }
  form input:focus, form select:focus, form textarea:focus {
    border-color: #007BFF;
    outline: none;
  }
  form textarea {
    resize: vertical;
    min-height: 70px;
  }
  form .buttons {
    margin-top: 15px;
    display: flex;
    gap: 12px;
  }
  form .buttons button {
    padding: 10px 16px;
    font-weight: 700;
    border-radius: 6px;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
  }
  button.save {
    background-color: #28a745;
  }
  button.save:hover {
    background-color: #1e7e34;
  }
  button.edit {
    background-color: #ffc107;
    color: #212529;
  }
  button.edit:hover {
    background-color: #e0a800;
  }
  button.cancel {
    background-color: #6c757d;
  }
  button.cancel:hover {
    background-color: #5a6268;
  }

  /* Tabla de pacientes */
  .table-container {
    overflow-x: auto;
    max-width: 100%;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 900px;
  }
  th, td {
    padding: 10px 14px;
    border-bottom: 1px solid #ddd;
    text-align: left;
    white-space: nowrap;
  }
  th {
    background-color: #007BFF;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  tr:hover {
    background-color: #f1faff;
  }
  td.actions button {
    margin-right: 6px;
    padding: 5px 10px;
    font-size: 0.9rem;
    border-radius: 6px;
    border: none;
    color: white;
    cursor: pointer;
  }
  td.actions button.delete {
    background-color: #dc3545;
  }
  td.actions button.delete:hover {
    background-color: #bd2130;
  }
  td.actions button.edit {
    background-color: #ffc107;
    color: #212529;
  }
  td.actions button.edit:hover {
    background-color: #e0a800;
  }

  /* Select estado paciente */
  #patient-status-filter {
    margin-bottom: 15px;
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    max-width: 280px;
  }

  /* WhatsApp Message Container */
  #whatsapp-container {
    max-width: 700px;
  }
  #whatsapp-container label {
    font-weight: 600;
  }
  #whatsapp-container select, #whatsapp-container textarea {
    width: 100%;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    padding: 8px 10px;
    font-size: 1rem;
    resize: vertical;
  }
  #whatsapp-container textarea {
    min-height: 100px;
  }
  #whatsapp-container button {
    background-color: #25d366;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #whatsapp-container button:hover {
    background-color: #1da851;
  }
  #whatsapp-container .note {
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 15px;
  }

  /* Responsive */
  @media (max-width: 900px) {
    #sidebar {
      position: fixed;
      height: 100vh;
      top: 0;
      left: 0;
      z-index: 1000;
      transform: translateX(-100%);
      box-shadow: 2px 0 6px rgb(0 0 0 / 0.2);
    }
    #sidebar.show {
      transform: translateX(0);
    }
    #hamburger {
      display: block;
    }
    #main-content {
      padding: 15px 15px 60px 15px;
      min-height: 100vh;
    }
    form .form-row {
      flex-direction: column;
    }
    form label, form input, form select, form textarea {
      flex: 1 0 auto;
      width: 100%;
    }
  }

  /* Pie de página */
  footer {
    background-color: #000;
    color: #fff;
    text-align: center;
    padding: 12px 0;
    font-weight: 600;
    user-select: none;
  }
</style>
</head>
<body>
<button id="hamburger" aria-label="Abrir menú">&#9776;</button>

<div id="app">
  <!-- Login -->
  <section id="login" aria-label="Login">
    <h2>Iniciar Sesión</h2>
    <form id="login-form" autocomplete="off" novalidate>
      <label for="username">Usuario</label>
      <input type="text" id="username" name="username" required aria-required="true" autocomplete="username" />
      <label for="password">Contraseña</label>
      <input type="password" id="password" name="password" required aria-required="true" autocomplete="current-password" />
      <div class="error" id="login-error" role="alert" aria-live="assertive"></div>
      <button type="submit">Entrar</button>
    </form>
  </section>

  <!-- Aplicación -->
  <aside id="sidebar" aria-label="Menú principal" class="hidden" tabindex="-1">
    <header>Menú</header>
    <nav role="navigation" aria-label="Opciones del menú">
      <button data-section="whatsapp" type="button">Enviar mensaje WhatsApp</button>
      <button data-section="pacientes-atendidos" type="button">Pacientes atendidos al día</button>
      <button data-section="pacientes-hospitalizados" type="button">Pacientes hospitalizados</button>
      <button data-section="pacientes-alta" type="button">Pacientes dados de alta</button>
      <button data-section="pacientes-fallecidos" type="button">Pacientes fallecidos</button>
      <button data-section="pacientes-nuevos" type="button">Nuevos ingresantes</button>
      <button data-section="ayuda" type="button">Ayuda</button>
      <button data-section="enlaces" type="button">Enlaces externos</button>
      <button id="logoutBtn" type="button" style="margin-top: 30px; background:#dc3545;">Cerrar sesión</button>
    </nav>
    <footer>© Salud 2026</footer>
  </aside>

  <main id="main-content" tabindex="0" aria-live="polite" aria-atomic="true" role="main">
    <!-- Aquí se cargan las secciones dinámicas -->
  </main>
</div>

<footer>© Salud 2026</footer>

<script>
(() => {
  'use strict';

  // Datos de usuario para login simple (en app real usar backend)
  const USER = 'admin';
  const PASS = '123456';

  // Elementos principales
  const loginSection = document.getElementById('login');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');

  const appContainer = document.getElementById('app');
  const sidebar = document.getElementById('sidebar');
  const mainContent = document.getElementById('main-content');
  const hamburger = document.getElementById('hamburger');
  const logoutBtn = document.getElementById('logoutBtn');
  const menuButtons = sidebar.querySelectorAll('nav button[data-section]');

  // Variables de estado
  let patients = []; // Array pacientes
  let currentEditId = null; // ID paciente en edición
  let currentSection = null;

  // LocalStorage keys
  const STORAGE_KEYS = {
    PATIENTS: 'patients_data',
    ATTENDED_LOG: 'attended_log', // para pacientes atendidos al día
  };

  // Estados posibles para pacientes
  const PATIENT_STATES = {
    HOSPITALIZADO: 'Hospitalizado',
    ALTA: 'Dado de alta',
    FALLECIDO: 'Fallecido',
    NUEVO_INGRESO: 'Nuevo ingreso',
    ACTIVO: 'Activo',
  };

  // --- Funciones auxiliares ---

  // Guardar pacientes a localStorage
  function savePatients() {
    localStorage.setItem(STORAGE_KEYS.PATIENTS, JSON.stringify(patients));
  }

  // Cargar pacientes desde localStorage
  function loadPatients() {
    const data = localStorage.getItem(STORAGE_KEYS.PATIENTS);
    patients = data ? JSON.parse(data) : [];
  }

  // Guardar pacientes atendidos del día
  function saveAttendedLog(log) {
    localStorage.setItem(STORAGE_KEYS.ATTENDED_LOG, JSON.stringify(log));
  }

  // Cargar pacientes atendidos del día
  function loadAttendedLog() {
    const data = localStorage.getItem(STORAGE_KEYS.ATTENDED_LOG);
    return data ? JSON.parse(data) : [];
  }

  // Generar ID único para paciente
  function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9);
  }

  // Limpiar formulario paciente
  function clearPatientForm(form) {
    form.reset();
    currentEditId = null;
    form.querySelector('button.save').textContent = 'Guardar';
  }

  // Crear fila en tabla pacientes
  function createPatientRow(patient) {
    const tr = document.createElement('tr');
    tr.dataset.id = patient.id;

    // Nombre
    const tdNombre = document.createElement('td');
    tdNombre.textContent = patient.nombre;
    tr.appendChild(tdNombre);

    // Apellido
    const tdApellido = document.createElement('td');
    tdApellido.textContent = patient.apellido;
    tr.appendChild(tdApellido);

    // Cédula identidad
    const tdCedula = document.createElement('td');
    tdCedula.textContent = patient.cedula;
    tr.appendChild(tdCedula);

    // Edad
    const tdEdad = document.createElement('td');
    tdEdad.textContent = patient.edad;
    tr.appendChild(tdEdad);

    // Teléfono
    const tdTelefono = document.createElement('td');
    tdTelefono.textContent = patient.telefono;
    tr.appendChild(tdTelefono);

    // Dirección
    const tdDireccion = document.createElement('td');
    tdDireccion.textContent = patient.direccion;
    tr.appendChild(tdDireccion);

    // Patología
    const tdPatologia = document.createElement('td');
    tdPatologia.textContent = patient.patologia;
    tr.appendChild(tdPatologia);

    // Tratamiento
    const tdTratamiento = document.createElement('td');
    tdTratamiento.textContent = patient.tratamiento;
    tr.appendChild(tdTratamiento);

    // Talla
    const tdTalla = document.createElement('td');
    tdTalla.textContent = patient.talla;
    tr.appendChild(tdTalla);

    // Peso
    const tdPeso = document.createElement('td');
    tdPeso.textContent = patient.peso;
    tr.appendChild(tdPeso);

    // Observación
    const tdObservacion = document.createElement('td');
    tdObservacion.textContent = patient.observacion;
    tr.appendChild(tdObservacion);

    // Estado
    const tdEstado = document.createElement('td');
    tdEstado.textContent = patient.estado || PATIENT_STATES.ACTIVO;
    tr.appendChild(tdEstado);

    // Acciones
    const tdActions = document.createElement('td');
    tdActions.classList.add('actions');

    // Editar
    const editBtn = document.createElement('button');
    editBtn.classList.add('edit');
    editBtn.title = 'Editar paciente';
    editBtn.setAttribute('aria-label', `Editar paciente 
        ${patient.nombre}
        ${patient.apellido}`);
    editBtn.textContent = 'Editar';
    editBtn.addEventListener('click', () => {
            loadPatientToForm(patient.id);
    });
    tdActions.appendChild(editBtn);

    // Eliminar
    const deleteBtn = document.createElement('button');
    deleteBtn.classList.add('delete');
    deleteBtn.title = 'Eliminar paciente';
    deleteBtn.setAttribute('aria-label', `Eliminar paciente
        ${patient.nombre}
        ${patient.apellido}`);
    deleteBtn.textContent = 'Eliminar';
    deleteBtn.addEventListener('click', () => {
      if (confirm(`¿Seguro que quieres eliminar al paciente 
          ${patient.nombre}
          ${patient.apellido}?`)) {
        deletePatient(patient.id);
      }
    });
    tdActions.appendChild(deleteBtn);

    tr.appendChild(tdActions);
    return tr;
  }

  // Cargar paciente en formulario para editar
  function loadPatientToForm(id) {
    const patient = patients.find(p => p.id === id);
    if (!patient) return;

    currentEditId = id;
    const form = document.getElementById('patient-form');

    form.nombre.value = patient.nombre;
    form.apellido.value = patient.apellido;
    form.cedula.value = patient.cedula;
    form.edad.value = patient.edad;
    form.telefono.value = patient.telefono;
    form.direccion.value = patient.direccion;
    form.patologia.value = patient.patologia;
    form.tratamiento.value = patient.tratamiento;
    form.talla.value = patient.talla;
    form.peso.value = patient.peso;
    form.observacion.value = patient.observacion;
    form.estado.value = patient.estado || PATIENT_STATES.ACTIVO;

    form.querySelector('button.save').textContent = 'Actualizar';
    // Scroll al formulario
    form.scrollIntoView({ behavior: 'smooth' });
  }

  // Eliminar paciente por id
  function deletePatient(id) {
    patients = patients.filter(p => p.id !== id);
    savePatients();
    renderPatientTable(currentSection);
  }

  // Agregar o actualizar paciente
  function savePatient(data) {
    if (currentEditId) {
      // Actualizar
      const index = patients.findIndex(p => p.id === currentEditId);
      if (index !== -1) {
        patients[index] = { id: currentEditId, ...data };
      }
    } else {
      // Nuevo
      const newPatient = { id: generateId(), ...data };
      patients.push(newPatient);
    }
    savePatients();
  }

  // Renderizar tabla pacientes, filtrando por estado si se indica
  function renderPatientTable(filterState = null) {
    mainContent.innerHTML = '';
    currentSection = filterState || 'all';

    // Título
    let title = 'Listado de pacientes';
    if (filterState && filterState !== 'all') {
      title += ` - ${filterState}`;
    }
    const h2 = document.createElement('h2');
    h2.textContent = title;
    mainContent.appendChild(h2);

    // Filtro de estado (solo si es sección 'all')
    if (filterState === 'all' || filterState === null) {
      const selectFilter = document.createElement('select');
      selectFilter.id = 'patient-status-filter';
      selectFilter.setAttribute('aria-label', 'Filtrar pacientes por estado');
      const options = ['Todos', ...Object.values(PATIENT_STATES)];
      options.forEach(opt => {
        const optionElement = document.createElement('option');
        optionElement.value = opt === 'Todos' ? 'all' : opt;
        optionElement.textContent = opt;
        selectFilter.appendChild(optionElement);
      });
      selectFilter.value = filterState || 'all';
      selectFilter.addEventListener('change', () => {
        renderPatientTable(selectFilter.value === 'all' ? null : selectFilter.value);
      });
      mainContent.appendChild(selectFilter);
    }

    // Botón Nuevo paciente
    const btnNew = document.createElement('button');
    btnNew.textContent = 'Nuevo paciente';
    btnNew.style.margin = '15px 0';
    btnNew.style.padding = '10px 16px';
    btnNew.style.backgroundColor = '#007BFF';
    btnNew.style.color = 'white';
    btnNew.style.border = 'none';
    btnNew.style.borderRadius = '6px';
    btnNew.style.fontWeight = '700';
    btnNew.addEventListener('click', () => {
      renderPatientForm();
    });
    mainContent.appendChild(btnNew);

    // Tabla
    const container = document.createElement('div');
    container.className = 'table-container';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    const headers = [
      'Nombre', 'Apellido', 'Cédula identidad', 'Edad', 'Teléfono',
      'Dirección', 'Patología', 'Tratamiento', 'Talla', 'Peso',
      'Observación', 'Estado', 'Acciones'
    ];
    headers.forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Filtrar pacientes si aplica
    let filteredPatients = patients;
    if (filterState && filterState !== 'all') {
      filteredPatients = patients.filter(p => (p.estado || PATIENT_STATES.ACTIVO) === filterState);
    }

    if (filteredPatients.length === 0) {
      const trEmpty = document.createElement('tr');
      const tdEmpty = document.createElement('td');
      tdEmpty.colSpan = headers.length;
      tdEmpty.style.textAlign = 'center';
      tdEmpty.textContent = 'No hay pacientes para mostrar.';
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
    } else {
      filteredPatients.forEach(patient => {
        tbody.appendChild(createPatientRow(patient));
      });
    }

    table.appendChild(tbody);
    container.appendChild(table);
    mainContent.appendChild(container);
  }

  // Renderizar formulario paciente
  function renderPatientForm() {
    mainContent.innerHTML = '';
    currentSection = 'form';

    const h2 = document.createElement('h2');
    h2.textContent = currentEditId ? 'Editar paciente' : 'Nuevo paciente';
    mainContent.appendChild(h2);

    const form = document.createElement('form');
    form.id = 'patient-form';
    form.setAttribute('aria-label', 'Formulario para agregar o editar paciente');
    // Evitar autocomplete para evitar datos cruzados
    form.autocomplete = 'off';

    // Campos
    const fields = [
      {label: 'Nombre', name: 'nombre', type: 'text', required: true},
      {label: 'Apellido', name: 'apellido', type: 'text', required: true},
      {label: 'Cédula identidad', name: 'cedula', type: 'text', required: true},
      {label: 'Edad', name: 'edad', type: 'number', min: 0, max: 120, required: true},
      {label: 'Teléfono', name: 'telefono', type: 'tel', pattern: '[0-9+\\- ]{6,15}', required: false},
      {label: 'Dirección', name: 'direccion', type: 'text', required: false},
      {label: 'Patología', name: 'patologia', type: 'text', required: false},
      {label: 'Tratamiento', name: 'tratamiento', type: 'text', required: false},
      {label: 'Talla (cm)', name: 'talla', type: 'number', min: 0, max: 300, step: 0.1, required: false},
      {label: 'Peso (kg)', name: 'peso', type: 'number', min: 0, max: 500, step: 0.1, required: false},
    ];

    const formRow = document.createElement('div');
    formRow.className = 'form-row';

    fields.forEach(f => {
      const label = document.createElement('label');
      label.setAttribute('for', f.name);
      label.textContent = f.label + (f.required ? ' *' : '');
      formRow.appendChild(label);

      const input = document.createElement('input');
      input.type = f.type;
      input.id = f.name;
      input.name = f.name;
      if (f.required) input.required = true;
      if ('min' in f) input.min = f.min;
      if ('max' in f) input.max = f.max;
      if ('step' in f) input.step = f.step;
      if (f.pattern) input.pattern = f.pattern;
      formRow.appendChild(input);
    });

    // Observación (textarea)
    const labelObs = document.createElement('label');
    labelObs.setAttribute('for', 'observacion');
    labelObs.textContent = 'Observación';
    formRow.appendChild(labelObs);
    const textareaObs = document.createElement('textarea');
    textareaObs.id = 'observacion';
    textareaObs.name = 'observacion';
    textareaObs.rows = 3;
    formRow.appendChild(textareaObs);

    // Estado paciente (select)
    const labelEstado = document.createElement('label');
    labelEstado.setAttribute('for', 'estado');
    labelEstado.textContent = 'Estado del paciente *';
    formRow.appendChild(labelEstado);
    const selectEstado = document.createElement('select');
    selectEstado.id = 'estado';
    selectEstado.name = 'estado';
    selectEstado.required = true;
    Object.values(PATIENT_STATES).forEach(state => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      selectEstado.appendChild(option);
    });
    formRow.appendChild(selectEstado);

    form.appendChild(formRow);

    // Botones guardar/cancelar
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'buttons';

    const btnSave = document.createElement('button');
    btnSave.type = 'submit';
    btnSave.className = 'save';
    btnSave.textContent = 'Guardar';
    buttonsDiv.appendChild(btnSave);

    const btnCancel = document.createElement('button');
    btnCancel.type = 'button';
    btnCancel.className = 'cancel';
    btnCancel.textContent = 'Cancelar';
    btnCancel.addEventListener('click', () => {
      clearPatientForm(form);
      renderPatientTable();
    });
    buttonsDiv.appendChild(btnCancel);

    form.appendChild(buttonsDiv);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = {};
      for (const [key, value] of formData.entries()) {
        data[key] = value.trim();
      }
      // Validar edad, talla, peso como números válidos
      if (data.edad && (isNaN(data.edad) || data.edad < 0 || data.edad > 120)) {
        alert('Por favor, ingresa una edad válida entre 0 y 120.');
        return;
      }
      if (data.talla && (isNaN(data.talla) || data.talla < 0 || data.talla > 300)) {
        alert('Por favor, ingresa una talla válida entre 0 y 300 cm.');
        return;
      }
      if (data.peso && (isNaN(data.peso) || data.peso < 0 || data.peso > 500)) {
        alert('Por favor, ingresa un peso válido entre 0 y 500 kg.');
        return;
      }
      savePatient(data);
      clearPatientForm(form);
      renderPatientTable();
    });

    mainContent.appendChild(form);

    // Si está en edición, cargar datos
    if (currentEditId) {
      loadPatientToForm(currentEditId);
    }
  }

  // Sección: Enviar mensaje WhatsApp
  function renderWhatsAppSection() {
    mainContent.innerHTML = '';
    currentSection = 'whatsapp';

    const container = document.createElement('div');
    container.id = 'whatsapp-container';

    const h2 = document.createElement('h2');
    h2.textContent = 'Enviar mensaje WhatsApp a familiar';
    container.appendChild(h2);

    if (patients.length === 0) {
      const p = document.createElement('p');
      p.textContent = 'No hay pacientes registrados para enviar mensajes.';
      container.appendChild(p);
      mainContent.appendChild(container);
      return;
    }

    // Select paciente
    const labelSelect = document.createElement('label');
    labelSelect.setAttribute('for', 'selectPaciente');
    labelSelect.textContent = 'Selecciona paciente:';
    container.appendChild(labelSelect);

    const selectPaciente = document.createElement('select');
    selectPaciente.id = 'selectPaciente';
    selectPaciente.name = 'selectPaciente';
    selectPaciente.required = true;

    // Opción placeholder
    const optionPlaceholder = document.createElement('option');
    optionPlaceholder.value = '';
    optionPlaceholder.textContent = '--Seleccione--';
    selectPaciente.appendChild(optionPlaceholder);

    patients.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.nombre} ${p.apellido} - Teléfono: ${p.telefono || 'No disponible'}`;
      selectPaciente.appendChild(option);
    });
    container.appendChild(selectPaciente);

    // Textarea mensaje editable
    const labelMsg = document.createElement('label');
    labelMsg.setAttribute('for', 'whatsappMsg');
    labelMsg.textContent = 'Mensaje (editable):';
    container.appendChild(labelMsg);

    const textareaMsg = document.createElement('textarea');
    textareaMsg.id = 'whatsappMsg';
    textareaMsg.placeholder = 'Escribe el mensaje para el familiar aquí...';
    textareaMsg.required = true;
    container.appendChild(textareaMsg);

    const note = document.createElement('p');
    note.className = 'note';
    note.textContent = 'El número de teléfono se enviará automáticamente, no lo coloques en el mensaje.';
    container.appendChild(note);

    // Botón enviar
    const btnSend = document.createElement('button');
    btnSend.textContent = 'Enviar mensaje WhatsApp';
    btnSend.type = 'button';

    btnSend.addEventListener('click', () => {
      const selectedId = selectPaciente.value;
      const msg = textareaMsg.value.trim();
      if (!selectedId) {
        alert('Por favor selecciona un paciente.');
        return;
      }
      if (!msg) {
        alert('Por favor ingresa un mensaje.');
        return;
      }
      const patient = patients.find(p => p.id === selectedId);
      if (!patient) {
        alert('Paciente no encontrado.');
        return;
      }
      if (!patient.telefono || patient.telefono.trim() === '') {
        alert('El paciente no tiene un número de teléfono válido para enviar el mensaje.');
        return;
      }
      // Formatear teléfono para WhatsApp: quitar espacios, guiones y signos +
      let phone = patient.telefono.replace(/\D/g, '');
      if (!phone.startsWith('+' || '')) {
        // Asumimos que es número local, se podría ampliar para países
        // Dejar como está, WhatsApp funciona con números sin signo + solo si están completos
      }
      // Codificar mensaje para url
      const encodedMsg = encodeURIComponent(msg);
      const waUrl = `https://chat.whatsapp.com?text=${phone}${encodedMsg}`;
      window.open(waUrl, '_blank');
    });

    container.appendChild(btnSend);

    mainContent.appendChild(container);
  }

  // Sección: Pacientes atendidos al día (registro con fecha y hora)
  function renderAttendedSection() {
    mainContent.innerHTML = '';
    currentSection = 'pacientes-atendidos';

    const h2 = document.createElement('h2');
    h2.textContent = 'Pacientes atendidos al día';
    mainContent.appendChild(h2);

    // Botón registrar paciente atendido (muestra lista para seleccionar)
    const btnRegister = document.createElement('button');
    btnRegister.textContent = 'Registrar paciente atendido hoy';
    btnRegister.style.marginBottom = '15px';
    btnRegister.style.backgroundColor = '#17a2b8';
    btnRegister.style.color = 'white';
    btnRegister.style.border = 'none';
    btnRegister.style.padding = '10px 16px';
    btnRegister.style.borderRadius = '6px';
    btnRegister.style.fontWeight = '700';
    btnRegister.addEventListener('click', () => {
      renderRegisterAttendedModal();
    });
    mainContent.appendChild(btnRegister);

    // Mostrar lista pacientes atendidos hoy
    const log = loadAttendedLog();
    const todayStr = new Date().toISOString().slice(0,10);

    // Filtrar solo de hoy
    const todayLog = log.filter(entry => entry.date.startsWith(todayStr));

    if (todayLog.length === 0) {
      const p = document.createElement('p');
      p.textContent = 'No hay pacientes registrados como atendidos hoy.';
      mainContent.appendChild(p);
      return;
    }

    // Tabla
    const container = document.createElement('div');
    container.className = 'table-container';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    const headers = ['Nombre', 'Apellido', 'Fecha y hora', 'Acciones'];
    headers.forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    todayLog.forEach(entry => {
      const tr = document.createElement('tr');

      const patient = patients.find(p => p.id === entry.patientId);

      const tdNombre = document.createElement('td');
      tdNombre.textContent = patient ? patient.nombre : 'Paciente eliminado';
      tr.appendChild(tdNombre);

      const tdApellido = document.createElement('td');
      tdApellido.textContent = patient ? patient.apellido : '';
      tr.appendChild(tdApellido);

      const tdDate = document.createElement('td');
      const d = new Date(entry.date);
      tdDate.textContent = d.toLocaleString();
      tr.appendChild(tdDate);

      const tdActions = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className = 'delete';
      delBtn.textContent = 'Eliminar';
      delBtn.title = 'Eliminar registro de paciente atendido';
      delBtn.addEventListener('click', () => {
        if (confirm('¿Eliminar este registro?')) {
          const idx = log.findIndex(l => l.id === entry.id);
          if (idx > -1) {
            log.splice(idx,1);
            saveAttendedLog(log);
            renderAttendedSection();
         
                   }
        }
      });
      tdActions.appendChild(delBtn);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
    mainContent.appendChild(container);
  }

  // Modal para registrar paciente atendido hoy
  function renderRegisterAttendedModal() {
    // Crear overlay modal
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.right = 0;
    overlay.style.bottom = 0;
    overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
    overlay.style.zIndex = 1100;
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';

    // Modal box
    const modal = document.createElement('div');
    modal.style.background = 'white';
    modal.style.borderRadius = '8px';
    modal.style.padding = '20px';
    modal.style.width = '90%';
    modal.style.maxWidth = '400px';
    modal.style.boxShadow = '0 0 15px rgba(0,0,0,0.3)';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-labelledby', 'modalTitle');

    const title = document.createElement('h3');
    title.id = 'modalTitle';
    title.textContent = 'Registrar paciente atendido hoy';
    modal.appendChild(title);

    const form = document.createElement('form');
    form.id = 'registerAttendedForm';

    // Select pacientes activos para registrar
    const labelSelect = document.createElement('label');
    labelSelect.setAttribute('for', 'selectPatientAttended');
    labelSelect.textContent = 'Selecciona paciente:';
    form.appendChild(labelSelect);

    const select = document.createElement('select');
    select.id = 'selectPatientAttended';
    select.name = 'selectPatientAttended';
    select.required = true;
    select.style.width = '100%';
    select.style.marginBottom = '15px';
    select.style.padding = '8px';
    select.style.borderRadius = '6px';
    select.style.border = '1px solid #ccc';

    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = '--Seleccione--';
    select.appendChild(placeholderOption);

    // Mostrar sólo pacientes activos (no fallecidos ni dados de alta)
    const activePatients = patients.filter(p => {
      const state = p.estado || PATIENT_STATES.ACTIVO;
      return state !== PATIENT_STATES.FALLECIDO && state !== PATIENT_STATES.ALTA;
    });

    activePatients.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.nombre} ${p.apellido}`;
      select.appendChild(option);
    });
    form.appendChild(select);

    // Botones
    const btnContainer = document.createElement('div');
    btnContainer.style.textAlign = 'right';

    const btnCancel = document.createElement('button');
    btnCancel.type = 'button';
    btnCancel.textContent = 'Cancelar';
    btnCancel.style.marginRight = '10px';
    btnCancel.style.padding = '8px 14px';
    btnCancel.style.backgroundColor = '#6c757d';
    btnCancel.style.color = 'white';
    btnCancel.style.border = 'none';
    btnCancel.style.borderRadius = '6px';
    btnCancel.addEventListener('click', () => {
      document.body.removeChild(overlay);
    });
    btnContainer.appendChild(btnCancel);

    const btnSubmit = document.createElement('button');
    btnSubmit.type = 'submit';
    btnSubmit.textContent = 'Registrar';
    btnSubmit.style.padding = '8px 14px';
    btnSubmit.style.backgroundColor = '#17a2b8';
    btnSubmit.style.color = 'white';
    btnSubmit.style.border = 'none';
    btnSubmit.style.borderRadius = '6px';
    btnContainer.appendChild(btnSubmit);

    form.appendChild(btnContainer);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const patientId = select.value;
      if (!patientId) {
        alert('Por favor selecciona un paciente.');
        return;
      }
      // Añadir registro con fecha y hora actual
      const log = loadAttendedLog();
      const entry = {
        id: generateId(),
        patientId,
        date: new Date().toISOString()
      };
      log.push(entry);
      saveAttendedLog(log);
      alert('Paciente registrado como atendido hoy.');
      document.body.removeChild(overlay);
      renderAttendedSection();
    });

    modal.appendChild(form);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Enfocar select al abrir
    select.focus();
  }

  // Renderizar otras secciones similares (hospitalizados, alta, fallecidos, nuevos ingresantes)
  // Estas secciones muestran pacientes filtrados por su estado y permiten cambiar el estado para evitar que estén en varias opciones al mismo tiempo.

  function renderPatientsByStateSection(state) {
    mainContent.innerHTML = '';
    currentSection = state;

    const h2 = document.createElement('h2');
    h2.textContent = `Pacientes - ${state}`;
    mainContent.appendChild(h2);

    // Botón para regresar a listado general
    const btnBack = document.createElement('button');
    btnBack.textContent = 'Volver a listado general';
    btnBack.style.marginBottom = '15px';
    btnBack.style.backgroundColor = '#007BFF';
    btnBack.style.color = 'white';
    btnBack.style.border = 'none';
    btnBack.style.padding = '10px 16px';
    btnBack.style.borderRadius = '6px';
    btnBack.style.fontWeight = '700';
    btnBack.addEventListener('click', () => {
      renderPatientTable();
    });
    mainContent.appendChild(btnBack);

    // Mostrar tabla filtrada
    const container = document.createElement('div');
    container.className = 'table-container';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    const headers = [
      'Nombre', 'Apellido', 'Cédula identidad', 'Edad', 'Teléfono',
      'Dirección', 'Patología', 'Tratamiento', 'Talla', 'Peso',
      'Observación', 'Estado', 'Acciones'
    ];
    headers.forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    const filteredPatients = patients.filter(p => (p.estado || PATIENT_STATES.ACTIVO) === state);

    if (filteredPatients.length === 0) {
      const trEmpty = document.createElement('tr');
      const tdEmpty = document.createElement('td');
      tdEmpty.colSpan = headers.length;
      tdEmpty.style.textAlign = 'center';
      tdEmpty.textContent = `No hay pacientes en estado ${state}.`;
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
    } else {
      filteredPatients.forEach(patient => {
        const tr = createPatientRow(patient);

        // Añadir botones para cambiar estado para evitar duplicidad
        const tdActions = tr.querySelector('td.actions');

        // Crear select para cambiar estado
        const selectChange = document.createElement('select');
        selectChange.style.marginLeft = '10px';
        selectChange.title = 'Cambiar estado del paciente';
        selectChange.setAttribute('aria-label', `Cambiar estado del paciente 
            ${patient.nombre} 
            ${patient.apellido}`);
        Object.values(PATIENT_STATES).forEach(st => {
          const option = document.createElement('option');
          option.value = st;
          option.textContent = st;
          if (st === (patient.estado || PATIENT_STATES.ACTIVO)) option.selected = true;
          selectChange.appendChild(option);
        });
        selectChange.addEventListener('change', () => {
          patient.estado = selectChange.value;
          savePatients();
          renderPatientsByStateSection(state);
        });
        tdActions.appendChild(selectChange);

        tbody.appendChild(tr);
      });
    }

    table.appendChild(tbody);
    container.appendChild(table);
    mainContent.appendChild(container);
  }

  // Sección ayuda
  function renderHelpSection() {
    mainContent.innerHTML = '';
    currentSection = 'ayuda';

    const h2 = document.createElement('h2');
    h2.textContent = 'Ayuda';
    mainContent.appendChild(h2);

    const p = document.createElement('p');
    p.innerHTML = `
      Esta aplicación permite llevar el control de pacientes clínicos.<br>
      <ul>
        <li>Inicia sesión con usuario y contraseña.</li>
        <li>Registra pacientes con sus datos completos.</li>
        <li>Filtra pacientes por estado: hospitalizado, alta, fallecido, nuevo ingreso.</li>
        <li>Envía mensajes personalizados vía WhatsApp a familiares sin colocar el número manualmente.</li>
        <li>Registra pacientes atendidos al día con fecha y hora.</li>
        <li>Guarda toda la información en el almacenamiento local de tu navegador.</li>
        <li>Accede fácilmente desde PC o móvil con diseño responsivo.</li>
      </ul>
      Para cualquier duda, consulta al administrador del sistema.
    `;
    mainContent.appendChild(p);
  }

  // Sección enlaces externos
  function renderLinksSection() {
    mainContent.innerHTML = '';
    currentSection = 'enlaces';

    const h2 = document.createElement('h2');
    h2.textContent = 'Enlaces externos';
    mainContent.appendChild(h2);

    const ul = document.createElement('ul');
    ul.style.paddingLeft = '20px';

    const links = [
      { text: 'Ministerio de Salud', url: 'https://www.minsalud.gov.co' },
      { text: 'Organización Mundial de la Salud (OMS)', url: 'https://www.who.int/es' },
      { text: 'Centro para el Control y Prevención de Enfermedades (CDC)', url: 'https://www.cdc.gov' },
      // Añade más enlaces relevantes aquí
    ];

    links.forEach(link => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = link.url;
      a.textContent = link.text;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.style.color = '#007BFF';
      a.style.textDecoration = 'none';
      a.addEventListener('mouseover', () => a.style.textDecoration = 'underline');
      a.addEventListener('mouseout', () => a.style.textDecoration = 'none');
      li.appendChild(a);
      ul.appendChild(li);
    });

    mainContent.appendChild(ul);
  }

  // Mostrar sección según botón menú
  function showSection(name) {
    switch(name) {
      case 'whatsapp': renderWhatsAppSection(); break;
      case 'pacientes-atendidos': renderAttendedSection(); break;
      case 'pacientes-hospitalizados': renderPatientsByStateSection(PATIENT_STATES.HOSPITALIZADO); break;
      case 'pacientes-alta': renderPatientsByStateSection(PATIENT_STATES.ALTA); break;
      case 'pacientes-fallecidos': renderPatientsByStateSection(PATIENT_STATES.FALLECIDO); break;
      case 'pacientes-nuevos': renderPatientsByStateSection(PATIENT_STATES.NUEVO_INGRESO); break;
      case 'ayuda': renderHelpSection(); break;
      case 'enlaces': renderLinksSection(); break;
      default: renderPatientTable(); break;
    }
  }

  // Login manejo
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const user = loginForm.username.value.trim();
    const pass = loginForm.password.value.trim();

    if (user === USER && pass === PASS) {
      loginError.textContent = '';
      loginSection.style.display = 'none';
      sidebar.classList.remove('hidden');
      sidebar.classList.remove('show');
      hamburger.style.display = 'block';
      mainContent.style.display = 'block';
      loadPatients();
      renderPatientTable();
      hamburger.setAttribute('aria-expanded', 'false');
      hamburger.focus();
    } else {
      loginError.textContent = 'Usuario o contraseña incorrectos.';
      loginForm.password.value = '';
      loginForm.password.focus();
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    if (confirm('¿Cerrar sesión?')) {
      loginSection.style.display = 'block';
      sidebar.classList.add('hidden');
      hamburger.style.display = 'none';
      mainContent.innerHTML = '';
      mainContent.style.display = 'none';
      loginForm.username.value = '';
      loginForm.password.value = '';
      loginForm.username.focus();
      currentEditId = null;
      currentSection = null;
    }
  });

  // Control desplegable menú hamburguesa
  hamburger.addEventListener('click', () => {
    if (sidebar.classList.contains('show')) {
      sidebar.classList.remove('show');
      hamburger.setAttribute('aria-expanded', 'false');
    } else {
      sidebar.classList.add('show');
      hamburger.setAttribute('aria-expanded', 'true');
    }
  });

  // Cerrar menú al seleccionar opción (en móvil)
  menuButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      showSection(btn.dataset.section);
      if (window.innerWidth <= 900) {
        sidebar.classList.remove('show');
        hamburger.setAttribute('aria-expanded', 'false');
        hamburger.focus();
      }
    });
  });

  // Al cargar la página, enfocamos en el usuario del login
  window.addEventListener('load', () => {
    loginForm.username.focus();
  });

  // Accesibilidad: cerrar menú con Escape
  window.addEventListener('keydown', e => {
    if (e.key === 'Escape' && sidebar.classList.contains('show')) {
      sidebar.classList.remove('show');
      hamburger.setAttribute('aria-expanded', 'false');
      hamburger.focus();
    }
  });

})();
</script>
</body>
</HTML>
